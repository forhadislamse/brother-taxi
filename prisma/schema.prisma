generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  RIDER
  DRIVER
  // PENDING
}

enum AdminApprovedStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum RideStatus {
  REQUESTED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum TransportStatus {
  ONGOING
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  FAILED
  COMPLETED
  REFUNDED
  REQUIRES_CAPTURE
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
}

enum FeeType {
  FIXED
  PERCENTAGE
}

enum RideType {
  MiniRide
  LongRide
  Other
}

enum NotificationType {
  ORDER_STATUS
  PAYMENT_STATUS
  VEHICLE_STATUS
  GENERAL
  PAYMENT
  REVIEW_ALERT
}


model User {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  fullName         String? @default("")
  dob              String? @default("")
  gender           Gender  @default(MALE)
  // nidNumber    String? @default("")
  idFrontImage String? @default("")
  idBackImage  String? @default("")

  referralCode String?
  documents    Json?
  address      String? @default("")

  phoneNumber String  @unique
  email       String?
  city        String?
  location    String? @default("")
  lat         Float?  @default(0)
  lng         Float?  @default(0)

  password               String?
  role                   UserRole
  status                 UserStatus @default(ACTIVE)
  otp                    Int?
  otpExpiresAt           DateTime?
  phoneVerificationToken String?
  isPhoneNumberVerify    Boolean    @default(false)
  // isVerified             Boolean    @default(false)
  profileImage           String?
  fcmToken               String?    @default("")
  isNotificationOn       Boolean    @default(false)
  isUserOnline           Boolean    @default(true)
  onBoarding             Boolean    @default(false)

  accountLink      String? @default("")
  stripeAccountUrl String? @default("")
  stripeCustomerId String? @default("")
  stripeAccountId  String? @default("")
  // walletBalance    Float   @default(5000)

  // Driver-specific (optional)
  licensePlate        String?
  drivingLicense      String?
  licenseFrontSide    String?             @default("")
  licenseBackSide     String?             @default("")
  judicialRecord      String[]            @default([])
  compulsoryInsurance String[]             @default([])
  taxiManufacturer    String?
  bhNumber            String?
  adminApprovedStatus AdminApprovedStatus @default(PENDING)
  // isApproved       Boolean @default(false)

  rating        Float? @default(0)
  totalDistance Float? @default(0)
  totalRides    Int?   @default(0)
  totalTrips    Int?   @default(0)
  averageRating Float  @default(0) // Average rating score
  reviewCount   Int    @default(0)

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  SentNotifications     Notification[] @relation("SentNotifications")
  ReceivedNotifications Notification[] @relation("ReceivedNotifications")
  // reviewsWritten   Review[]             @relation("")
  // reviewsReceived  Review[]             @relation("DriverReview")
  reviewsGiven          Review[]       @relation("Reviewer")
  reviewsReceived       Review[]       @relation("Reviewee")
  estimateFares         EstimateFare[]
  vehicles              Vehicle[]
  carTransports         CarTransport[]
  Chat                  Chat[]         @relation("SenderChat")
  Message               Message[]
  driverChats           Chat[]         @relation("DriverChat")
  Driver                CarTransport[] @relation("Driver")
  Sender                CarTransport[] @relation("Sender")
  paymentsSent          Payment[]      @relation("PaymentSender")
  paymentsReceived      Payment[]      @relation("PaymentReceiver")
  savedCards            SavedCard[]
  ridePlan              ridePlan[]

  @@map("users")
}

model CarTransport {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String @db.ObjectId
  vehicleId String @db.ObjectId

  // ───── Ride Locations
  pickupLocation  String? @default("")
  dropOffLocation String? @default("")
  pickupLat       Float?  @default(0)
  pickupLng       Float?  @default(0)
  dropOffLat      Float?  @default(0)
  dropOffLng      Float?  @default(0)
  driverLat       Float?  @default(0)
  driverLng       Float?  @default(0)

  // ───── Fare & Payment
  totalAmount     Float?        @default(0)
  distance        Float
  platformFee     Float?        @default(0)
  platformFeeType String?       @default("")
  paymentMethod   String?       @default("CARD")
  paymentStatus   PaymentStatus @default(PENDING)
  isPayment       Boolean       @default(false)

  // ───── Scheduling
  pickupDate  String? @default("")
  pickupTime  String? @default("")
  rideTime    Float?  @default(0)
  waitingTime Float?  @default(0)

  // ───── Status Tracking
  status                  TransportStatus @default(PENDING)
  assignedDriver          String?         @db.ObjectId
  assignedDriverReqStatus String?         @default("PENDING")
  isDriverReqCancel       Boolean         @default(true)
  arrivalConfirmation     Boolean         @default(false)
  journeyStarted          Boolean         @default(false)
  journeyCompleted        Boolean         @default(false)
  serviceType             RideType

  // ───── Service Details
  // serviceType   ServiceType @default(Airport_pickup)
  specialNotes String? @default("")

  // ───── Media / Evidence
  beforePickupImages String[] @default([])
  afterPickupImages  String[] @default([])

  // ───── Cancellation
  cancelReason String? @default("") // Optional: user can provide reason for cancel

  // ───── Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ───── Relations
  ridePlanId String? @db.ObjectId // <-- connect to ridePlan

  // Relations
  ridePlan ridePlan? @relation(fields: [ridePlanId], references: [id])
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle  Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver   User?     @relation("Driver", fields: [assignedDriver], references: [id], onDelete: Cascade)
  sender   User?     @relation("Sender", fields: [userId], references: [id], onDelete: Cascade)

  Review  Review[] // ride feedback
  // fare   Fare[]
  Chat    Chat[] // chat between rider and driver
  Payment Payment[] @relation("carTransportPayment") // multiple payments if needed

  @@map("carTransports")
}

model ridePlan {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId // the rider/user who requested the plan
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Pickup & Drop-off names
  pickup  String
  dropOff String

  // Coordinates
  pickupLat  Float
  pickupLng  Float
  dropOffLat Float
  dropOffLng Float

  // Ride info
  rideTime      Float  @default(0)
  waitingTime   Float  @default(0)
  distance      Float
  estimatedFare Float
  serviceType   String

  carTransport CarTransport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Chat {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  carTransportId String   @db.ObjectId
  senderId       String   @db.ObjectId
  driverId       String   @db.ObjectId
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  carTransport CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)
  sender       User         @relation("SenderChat", fields: [senderId], references: [id], onDelete: Cascade)
  driver       User         @relation("DriverChat", fields: [driverId], references: [id], onDelete: Cascade)

  messages Message[]

  @@map("chats")
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ChatId    String   @db.ObjectId
  senderId  String   @db.ObjectId
  message   String?
  images    String[] @default([])
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Chat   Chat @relation(fields: [ChatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Payment {
  id                          String        @id @default(auto()) @map("_id") @db.ObjectId
  paymentId                   String // Stripe payment intent ID or custom ID for cash
  transportId                 String?       @db.ObjectId
  senderId                    String?       @db.ObjectId
  receiverId                  String?       @db.ObjectId
  amount                      Float
  platformFee                 Float
  driverFee                   Float?
  platformFeeType             FeeType       @default(PERCENTAGE)
  paymentMethod               PaymentMethod @default(CASH)
  paymentStatus               PaymentStatus @default(PENDING)
  stripePaymentIntentId       String?
  stripePlatformFeeTransferId String?
  stripeDriverTransferId      String?
  refundId                    String?
  metadata                    Json?
  isHold                      Boolean       @default(false)
  holdReleaseDate             DateTime?
  paymentDate                 DateTime?     @default(now())
  createdAt                   DateTime      @default(now())
  updatedAt                   DateTime      @updatedAt

  sender       User?         @relation("PaymentSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver     User?         @relation("PaymentReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  carTransport CarTransport? @relation("carTransportPayment", fields: [transportId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model SavedCard {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  cardType              String
  last4                 String
  expiryMonth           Int
  expiryYear            Int
  isDefault             Boolean  @default(false)
  stripePaymentMethodId String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_cards")
}

model EstimateFare {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  pickup        String?
  dropOff       String?
  pickupLat     Float
  pickupLng     Float
  dropOffLat    Float
  dropOffLng    Float
  distance      Float?
  duration      Float?
  totalFare     Float
  // baseFare      Float
  costPerKm     Float
  costPerMin    Float
  minimumFare   Float
  // waitingPerMin Float
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("estimateFares")
}

// Enums

// enum ServiceType {
//   Airport_pickup
//   Airport_dropoff
//   City_ride
//   Parcel_delivery
// }

model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  title     String
  body      String
  type      NotificationType @default(GENERAL)
  data      String?
  // targetId  String?          @default("")
  targetId  String?          @db.ObjectId
  slug      String?          @default("")
  fcmToken  String?          @default("")
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation("SentNotifications", fields: [userId], references: [id], onDelete: Cascade)
  target    User?            @relation("ReceivedNotifications", fields: [targetId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Review {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  reviewerId     String   @db.ObjectId // যে review দিয়েছে
  revieweeId     String   @db.ObjectId // যাকে review দেওয়া হয়েছে
  carTransportId String   @db.ObjectId
  rating         Int      @default(0)
  comment        String?
  isFlagged      Boolean  @default(false) // optional: admin filter-এর জন্য
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  reviewer     User         @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee     User         @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)
  carTransport CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)

  @@unique([reviewerId, carTransportId]) // এক রাইডে একবারই রিভিউ দিতে পারবে
  @@map("reviews")
}

model Vehicle {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  userId             String   @db.ObjectId
  manufacturer       String
  model              String?
  year               Int?
  image              String?
  color              String?
  licensePlateNumber String?
  isActive           Boolean? @default(true)
  bh                 String? // same as your schema
  // refferalCode       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  driver        User           @relation(fields: [userId], references: [id])
  carTransports CarTransport[] // Opposite relation field for CarTransport.vehicle

  @@map("vehicles")
}

model Fare {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  // carTransportId String       @db.ObjectId
  // carTransport   CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)
  baseFare      Float?
  costPerKm     Float
  costPerMin    Float?
  minimumFare   Float?
  waitingPerMin Float?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("fares")
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  RIDER
  DRIVER
  // PENDING
}

enum AdminApprovedStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum RideStatus {
  REQUESTED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum TransportStatus {
  ONGOING
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  FAILED
  COMPLETED
  REFUNDED
  REQUIRES_CAPTURE
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
}

enum FeeType {
  FIXED
  PERCENTAGE
}

enum RideType {
  MiniRide
  LongRide
  Other
}

enum NotificationType {
  ORDER_STATUS
  PAYMENT_STATUS
  VEHICLE_STATUS
  GENERAL
  PAYMENT
}

// model User {
//   // ───── Identity
//   id           String  @id @default(auto()) @map("_id") @db.ObjectId
//   fullName     String? @default("")
//   dob          String? @default("") // Date of Birth
//   gender       Gender? @default(MALE)
//   nidNumber    String? @default("") // National ID / SSN
//   referralCode String? // For referral program
//   documents    Json? // Store extra driver/rider documents
//   address      String? @default("") // Permanent address text

//   // ───── Contact Info
//   phoneNumber String  @unique
//   email       String? 
//   city        String? // City for drivers
//   location    String? @default("") // Current address text
//   lat         Float?  @default(0) // Current latitude
//   lng         Float?  @default(0) // Current longitude

//   // ───── Authentication & Security
//   password               String?
//   role                   UserRole   @default(PENDING)
//   status                 UserStatus @default(ACTIVE)
//   otp                    Int?
//   otpExpiresAt           DateTime?  @default(now())
//   phoneVerificationToken String?    @default("")
//   isPhoneNumberVerify    Boolean    @default(false)

//   // ───── Profile & Preferences
//   profileImage     String?
//   fcmToken         String? @default("")
//   isNotificationOn Boolean @default(false)
//   isUserOnline     Boolean @default(true)
//   onBoarding       Boolean @default(false)

//   // ───── Driver Specific
//   licensePlate     String? // Car license plate
//   drivingLicense   String? // Driving license number or file
//   licenseFrontSide String? @default("")
//   licenseBackSide  String? @default("")
//   taxiManufacturer String? // Car brand (e.g. Toyota, Honda)
//   bhNumber         String? // Driver badge number
//   isApproved       Boolean @default(false) // Admin approval for drivers

//   // ───── Stats & Metrics
//   rating        Float? @default(0)
//   totalDistance Float? @default(0) // In kilometers
//   totalRides    Int?   @default(0) // Rider trips count
//   totalTrips    Int?   @default(0) // Driver trips count

//   // ───── Timestamps
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   // ───── Relationships
//   ridesAsRider    Ride[]   @relation("RiderRides")
//   ridesAsDriver   Ride[]   @relation("DriverRides")
//   reviewsGiven    Review[] @relation("ReviewsGiven")
//   reviewsReceived Review[] @relation("ReviewsReceived")
//   wallet          Wallet?
//   vehicles        Vehicle[]

//   @@map("users")
// }

model User {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  fullName     String? @default("")
  dob          String? @default("")
  gender       Gender  @default(MALE)
  nidNumber    String? @default("")
  referralCode String?
  documents    Json?
  address      String? @default("")

  phoneNumber String  @unique
  email       String?
  city        String?
  location    String? @default("")
  lat         Float?  @default(0)
  lng         Float?  @default(0)

  password               String?
  role                   UserRole
  status                 UserStatus @default(ACTIVE)
  otp                    Int?
  otpExpiresAt           DateTime?
  phoneVerificationToken String?
  isPhoneNumberVerify    Boolean    @default(false)

  profileImage     String?
  fcmToken         String? @default("")
  isNotificationOn Boolean @default(false)
  isUserOnline     Boolean @default(true)
  onBoarding       Boolean @default(false)

  accountLink      String? @default("")
  stripeAccountUrl String? @default("")
  stripeCustomerId String? @default("")
  stripeAccountId  String? @default("")
  walletBalance    Float   @default(5000)

  // Driver-specific (optional)
  licensePlate        String?
  drivingLicense      String?
  licenseFrontSide    String?             @default("")
  licenseBackSide     String?             @default("")
  taxiManufacturer    String?
  bhNumber            String?
  adminApprovedStatus AdminApprovedStatus @default(PENDING)
  // isApproved       Boolean @default(false)

  rating        Float? @default(0)
  totalDistance Float? @default(0)
  totalRides    Int?   @default(0)
  totalTrips    Int?   @default(0)
  averageRating Float  @default(0) // Average rating score
  reviewCount   Int    @default(0)

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  notifications    Notification[]
  // reviewsWritten   Review[]             @relation("")
  // reviewsReceived  Review[]             @relation("DriverReview")
  reviewsGiven     Review[]       @relation("Reviewer")
  reviewsReceived  Review[]       @relation("Reviewee")
  estimateFares    EstimateFare[]
  vehicles         Vehicle[]
  carTransports    CarTransport[]
  Chat             Chat[]         @relation("SenderChat")
  Message          Message[]
  driverChats      Chat[]         @relation("DriverChat")
  Driver           CarTransport[] @relation("Driver")
  Sender           CarTransport[] @relation("Sender")
  paymentsSent     Payment[]      @relation("PaymentSender")
  paymentsReceived Payment[]      @relation("PaymentReceiver")
  savedCards       SavedCard[]

  @@map("users")
}

// model Wallet {
//   id      String @id @default(auto()) @map("_id") @db.ObjectId
//   balance Float  @default(0)
//   userId  String @unique @db.ObjectId
//   user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

//   @@map("wallets")
// }

// model Ride {
//   id              String     @id @default(auto()) @map("_id") @db.ObjectId
//   distance        Float
//   fare            Float
//   startTime       DateTime
//   endTime         DateTime?
//   status          RideStatus
//   pickupLocation  String
//   dropoffLocation String
//   riderId         String     @db.ObjectId
//   driverId        String?    @db.ObjectId
//   rider           User       @relation("RiderRides", fields: [riderId], references: [id])
//   driver          User?      @relation("DriverRides", fields: [driverId], references: [id])
//   reviews         Review[]
//   createdAt       DateTime   @default(now())

//   @@map("rides")
// }

model CarTransport {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String @db.ObjectId
  vehicleId String @db.ObjectId

  // ───── Ride Locations
  pickupLocation  String? @default("")
  dropOffLocation String? @default("")
  pickupLat       Float?  @default(0)
  pickupLng       Float?  @default(0)
  dropOffLat      Float?  @default(0)
  dropOffLng      Float?  @default(0)
  driverLat       Float?  @default(0)
  driverLng       Float?  @default(0)

  // ───── Fare & Payment
  totalAmount     Float?        @default(0)
  distance        Float
  platformFee     Float?        @default(0)
  platformFeeType String?       @default("")
  paymentMethod   String?       @default("CARD")
  paymentStatus   PaymentStatus @default(PENDING)
  isPayment       Boolean       @default(false)

  // ───── Scheduling
  pickupDate  String? @default("")
  pickupTime  String? @default("")
  rideTime    String? @default("")
  waitingTime String? @default("")

  // ───── Status Tracking
  status                  TransportStatus @default(PENDING)
  assignedDriver          String?         @db.ObjectId
  assignedDriverReqStatus String?         @default("PENDING")
  isDriverReqCancel       Boolean         @default(true)
  arrivalConfirmation     Boolean         @default(false)
  journeyStarted          Boolean         @default(false)
  journeyCompleted        Boolean         @default(false)
  serviceType             RideType

  // ───── Service Details
  // serviceType   ServiceType @default(Airport_pickup)
  specialNotes String? @default("")

  // ───── Media / Evidence
  beforePickupImages String[] @default([])
  afterPickupImages  String[] @default([])

  // ───── Cancellation
  cancelReason String? @default("") // Optional: user can provide reason for cancel

  // ───── Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ───── Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver  User?   @relation("Driver", fields: [assignedDriver], references: [id], onDelete: Cascade)
  sender  User?   @relation("Sender", fields: [userId], references: [id], onDelete: Cascade)

  Review  Review[] // ride feedback
  // fare   Fare[]
  Chat    Chat[] // chat between rider and driver
  Payment Payment[] @relation("carTransportPayment") // multiple payments if needed

  @@map("carTransports")
}

model Chat {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  carTransportId String   @db.ObjectId
  senderId       String   @db.ObjectId
  driverId       String   @db.ObjectId
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  carTransport CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)
  sender       User         @relation("SenderChat", fields: [senderId], references: [id], onDelete: Cascade)
  driver       User         @relation("DriverChat", fields: [driverId], references: [id], onDelete: Cascade)

  messages Message[]

  @@map("chats")
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ChatId    String   @db.ObjectId
  senderId  String   @db.ObjectId
  message   String?
  images    String[] @default([])
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Chat   Chat @relation(fields: [ChatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Payment {
  id                          String        @id @default(auto()) @map("_id") @db.ObjectId
  paymentId                   String // Stripe payment intent ID or custom ID for cash
  transportId                 String?       @db.ObjectId
  senderId                    String?       @db.ObjectId
  receiverId                  String?       @db.ObjectId
  amount                      Float
  platformFee                 Float
  driverFee                   Float?
  platformFeeType             FeeType       @default(PERCENTAGE)
  paymentMethod               PaymentMethod @default(CARD)
  paymentStatus               PaymentStatus @default(PENDING)
  stripePaymentIntentId       String?
  stripePlatformFeeTransferId String?
  stripeDriverTransferId      String?
  refundId                    String?
  metadata                    Json?
  isHold                      Boolean       @default(false)
  holdReleaseDate             DateTime?
  paymentDate                 DateTime?     @default(now())
  createdAt                   DateTime      @default(now())
  updatedAt                   DateTime      @updatedAt

  sender       User?         @relation("PaymentSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver     User?         @relation("PaymentReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  carTransport CarTransport? @relation("carTransportPayment", fields: [transportId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model SavedCard {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  cardType              String
  last4                 String
  expiryMonth           Int
  expiryYear            Int
  isDefault             Boolean  @default(false)
  stripePaymentMethodId String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_cards")
}

model EstimateFare {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  pickup        String?
  dropOff       String?
  pickupLat     Float
  pickupLng     Float
  dropOffLat    Float
  dropOffLng    Float
  distance      Float?
  totalFare     Float
  baseFare      Float
  costPerKm     Float
  costPerMin    Float
  minimumFare   Float
  waitingPerMin Float
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("estimateFares")
}

// Enums

// enum ServiceType {
//   Airport_pickup
//   Airport_dropoff
//   City_ride
//   Parcel_delivery
// }

model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  title     String
  body      String
  type      NotificationType @default(GENERAL)
  data      String?
  targetId  String?          @default("")
  slug      String?          @default("")
  fcmToken  String?          @default("")
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// model Review {
//   id             String   @id @default(auto()) @map("_id") @db.ObjectId
//   userId         String   @db.ObjectId
//   driverId       String   @db.ObjectId
//   carTransportId String   @db.ObjectId
//   rating         Int      @default(0)
//   comment        String?
//   createdAt      DateTime @default(now())
//   updatedAt      DateTime @updatedAt

//   // Relations
//   user         User         @relation("UserReview", fields: [userId], references: [id], onDelete: Cascade)
//   driver       User         @relation("DriverReview", fields: [driverId], references: [id], onDelete: Cascade)
//   carTransport CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)

//   @@unique([userId, carTransportId])
//   @@map("reviews")
// }

model Review {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  reviewerId     String   @db.ObjectId // যে review দিয়েছে
  revieweeId     String   @db.ObjectId // যাকে review দেওয়া হয়েছে
  carTransportId String   @db.ObjectId
  rating         Int      @default(0)
  comment        String?
  isFlagged      Boolean  @default(false) // optional: admin filter-এর জন্য
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  reviewer     User         @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee     User         @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)
  carTransport CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)

  @@unique([reviewerId, carTransportId]) // এক রাইডে একবারই রিভিউ দিতে পারবে
  @@map("reviews")
}

model Vehicle {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  userId             String   @db.ObjectId
  manufacturer       String
  model              String
  year               Int
  image              String?
  color              String
  licensePlateNumber String
  isActive           Boolean  @default(true)
  bh                 String // same as your schema
  refferalCode       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  driver        User           @relation(fields: [userId], references: [id])
  carTransports CarTransport[] // Opposite relation field for CarTransport.vehicle

  @@map("vehicles")
}

model Fare {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  // carTransportId String       @db.ObjectId
  // carTransport   CarTransport @relation(fields: [carTransportId], references: [id], onDelete: Cascade)
  baseFare      Float?
  costPerKm     Float
  costPerMin    Float?
  minimumFare   Float?
  waitingPerMin Float?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("fares")
}
